/*
Programming for Data Science with Python Nanodegree
Udacity's certified program > SQL practice > Lesson 6 : SQL Window Functions

WINDOW FUNCTIONS:

Section 5:
Quiz: Running_total

Question:
create a running total of standard_amt_usd (in the orders table) over
order time, but this time, date truncate occurred_at by year and partition by
that same year-truncated occurred_at variable. Your final table should have
three columns: One with the amount being added for each row, one for the
truncated date, and a final column with the running total within each year.
*/

SELECT DATE_TRUNC('year', occurred_at) AS year,
       standard_amt_usd,
       SUM(standard_amt_usd) OVER( PARTITION BY DATE_TRUNC('year', occurred_at) ORDER BY occurred_at) AS running_total
FROM orders;

/*
Output6912 results
year	standard_amt_usd	running_total
2013-01-01T00:00:00.000Z	0.00	0.00
2013-01-01T00:00:00.000Z	2445.10	2445.10
2013-01-01T00:00:00.000Z	2634.72	5079.82
2013-01-01T00:00:00.000Z	0.00	5079.82
2013-01-01T00:00:00.000Z	2455.08	7534.90
2013-01-01T00:00:00.000Z	2504.98	10039.88
2013-01-01T00:00:00.000Z	264.47	10304.35
2013-01-01T00:00:00.000Z	1536.92	11841.27
2013-01-01T00:00:00.000Z	374.25	12215.52
2013-01-01T00:00:00.000Z	1402.19	13617.71
2013-01-01T00:00:00.000Z	59.88	13677.59
2013-01-01T00:00:00.000Z	2300.39	15977.98
2013-01-01T00:00:00.000Z	2445.10	18423.08
2013-01-01T00:00:00.000Z	214.57	18637.65
2013-01-01T00:00:00.000Z	424.15	19061.80
2013-01-01T00:00:00.000Z	2380.23	21442.03
2013-01-01T00:00:00.000Z	8882.20	30324.23
2013-01-01T00:00:00.000Z	2499.99	32824.22
2013-01-01T00:00:00.000Z	0.00	32824.22
2013-01-01T00:00:00.000Z	2499.99	35324.21
2013-01-01T00:00:00.000Z	2400.19	37724.40
2013-01-01T00:00:00.000Z	0.00	37724.40
2013-01-01T00:00:00.000Z	2450.09	40174.49
2013-01-01T00:00:00.000Z	0.00	40174.49
2013-01-01T00:00:00.000Z	2499.99	42674.48
2013-01-01T00:00:00.000Z	0.00	42674.48
2013-01-01T00:00:00.000Z	3188.61	45863.09
2013-01-01T00:00:00.000Z	1546.90	47409.99
2013-01-01T00:00:00.000Z	1082.83	48492.82
2013-01-01T00:00:00.000Z	708.58	49201.40
2013-01-01T00:00:00.000Z	1551.89	50753.29
2013-01-01T00:00:00.000Z	429.14	51182.43
2013-01-01T00:00:00.000Z	2415.16	53597.59
2013-01-01T00:00:00.000Z	738.52	54336.11
2013-01-01T00:00:00.000Z	474.05	54810.16
2013-01-01T00:00:00.000Z	2564.86	57375.02
2013-01-01T00:00:00.000Z	189.62	57564.64
2013-01-01T00:00:00.000Z	1492.01	59056.65
2013-01-01T00:00:00.000Z	748.50	59805.15
2013-01-01T00:00:00.000Z	1571.85	61377.00
2013-01-01T00:00:00.000Z	0.00	61377.00
2013-01-01T00:00:00.000Z	2574.84	63951.84
2013-01-01T00:00:00.000Z	0.00	63951.84
2013-01-01T00:00:00.000Z	5244.49	69196.33
2013-01-01T00:00:00.000Z	2659.67	71856.00
2013-01-01T00:00:00.000Z	99.80	71955.80
2013-01-01T00:00:00.000Z	2440.11	74395.91
2013-01-01T00:00:00.000Z	2524.94	76920.85
2013-01-01T00:00:00.000Z	2450.09	79370.94
2013-01-01T00:00:00.000Z	0.00	79370.94
2013-01-01T00:00:00.000Z	2460.07	81831.01
2013-01-01T00:00:00.000Z	314.37	82145.38
2013-01-01T00:00:00.000Z	1896.20	84041.58
2013-01-01T00:00:00.000Z	1691.61	85733.19
2013-01-01T00:00:00.000Z	753.49	86486.68
2013-01-01T00:00:00.000Z	1497.00	87983.68
2013-01-01T00:00:00.000Z	339.32	88323.00
2013-01-01T00:00:00.000Z	533.93	88856.93
2013-01-01T00:00:00.000Z	2499.99	91356.92
2013-01-01T00:00:00.000Z	169.66	91526.58
2013-01-01T00:00:00.000Z	1427.14	92953.72
2013-01-01T00:00:00.000Z	2514.96	95468.68
2013-01-01T00:00:00.000Z	344.31	95812.99
2013-01-01T00:00:00.000Z	1447.10	97260.09
2013-01-01T00:00:00.000Z	2480.03	99740.12
2013-01-01T00:00:00.000Z	0.00	99740.12
2013-01-01T00:00:00.000Z	334.33	100074.45
2013-01-01T00:00:00.000Z	1521.95	101596.40
2013-01-01T00:00:00.000Z	1442.11	103038.51
2013-01-01T00:00:00.000Z	0.00	103038.51
2013-01-01T00:00:00.000Z	2400.19	105438.70
2013-01-01T00:00:00.000Z	29.94	105468.64
2013-01-01T00:00:00.000Z	1387.22	106855.86
2013-01-01T00:00:00.000Z	149.70	107005.56
2013-01-01T00:00:00.000Z	708.58	107714.14
2013-01-01T00:00:00.000Z	289.42	108003.56
2013-01-01T00:00:00.000Z	1516.96	109520.52
2013-01-01T00:00:00.000Z	2534.92	112055.44
2013-01-01T00:00:00.000Z	548.90	112604.34
2013-01-01T00:00:00.000Z	459.08	113063.42
2013-01-01T00:00:00.000Z	1581.83	114645.25
2013-01-01T00:00:00.000Z	419.16	115064.41
2013-01-01T00:00:00.000Z	1482.03	116546.44
2013-01-01T00:00:00.000Z	284.43	116830.87
2013-01-01T00:00:00.000Z	0.00	116830.87
2013-01-01T00:00:00.000Z	1761.47	118592.34
2013-01-01T00:00:00.000Z	2485.02	121077.36
2013-01-01T00:00:00.000Z	0.00	121077.36
2013-01-01T00:00:00.000Z	1516.96	122594.32
2013-01-01T00:00:00.000Z	254.49	122848.81
2013-01-01T00:00:00.000Z	1432.13	124280.94
2013-01-01T00:00:00.000Z	204.59	124485.53
2013-01-01T00:00:00.000Z	2485.02	126970.55
2013-01-01T00:00:00.000Z	748.50	127719.05
2013-01-01T00:00:00.000Z	49.90	127768.95
2013-01-01T00:00:00.000Z	1327.34	129096.29
2013-01-01T00:00:00.000Z	394.21	129490.50
2013-01-01T00:00:00.000Z	593.81	130084.31
2013-01-01T00:00:00.000Z	2420.15	132504.46
2014-01-01T00:00:00.000Z	2569.85	2569.85
2014-01-01T00:00:00.000Z	0.00	2569.85
2014-01-01T00:00:00.000Z	184.63	2754.48
2014-01-01T00:00:00.000Z	1362.27	4116.75
2014-01-01T00:00:00.000Z	2450.09	6566.84
*/


/*
Same query with more clean data is written below:
*/

SELECT DATE_PART('year', occurred_at) AS year,
       standard_amt_usd,
       SUM(standard_amt_usd) OVER ( PARTITION BY DATE_TRUNC('year', occurred_at) ORDER BY occurred_at) AS running_total
FROM orders;

/*
Output6912 results
year	standard_amt_usd	running_total
2013	0.00	0.00
2013	2445.10	2445.10
2013	2634.72	5079.82
2013	0.00	5079.82
2013	2455.08	7534.90
2013	2504.98	10039.88
2013	264.47	10304.35
2013	1536.92	11841.27
2013	374.25	12215.52
2013	1402.19	13617.71
2013	59.88	13677.59
2013	2300.39	15977.98
2013	2445.10	18423.08
2013	214.57	18637.65
2013	424.15	19061.80
2013	2380.23	21442.03
2013	8882.20	30324.23
2013	2499.99	32824.22
2013	0.00	32824.22
2013	2499.99	35324.21
2013	2400.19	37724.40
2013	0.00	37724.40
2013	2450.09	40174.49
2013	0.00	40174.49
2013	2499.99	42674.48
2013	0.00	42674.48
2013	3188.61	45863.09
2013	1546.90	47409.99
2013	1082.83	48492.82
2013	708.58	49201.40
2013	1551.89	50753.29
2013	429.14	51182.43
2013	2415.16	53597.59
2013	738.52	54336.11
2013	474.05	54810.16
2013	2564.86	57375.02
2013	189.62	57564.64
2013	1492.01	59056.65
2013	748.50	59805.15
2013	1571.85	61377.00
2013	0.00	61377.00
2013	2574.84	63951.84
2013	0.00	63951.84
2013	5244.49	69196.33
2013	2659.67	71856.00
2013	99.80	71955.80
2013	2440.11	74395.91
2013	2524.94	76920.85
2013	2450.09	79370.94
2013	0.00	79370.94
2013	2460.07	81831.01
2013	314.37	82145.38
2013	1896.20	84041.58
2013	1691.61	85733.19
2013	753.49	86486.68
2013	1497.00	87983.68
2013	339.32	88323.00
2013	533.93	88856.93
2013	2499.99	91356.92
2013	169.66	91526.58
2013	1427.14	92953.72
2013	2514.96	95468.68
2013	344.31	95812.99
2013	1447.10	97260.09
2013	2480.03	99740.12
2013	0.00	99740.12
2013	334.33	100074.45
2013	1521.95	101596.40
2013	1442.11	103038.51
2013	0.00	103038.51
2013	2400.19	105438.70
2013	29.94	105468.64
2013	1387.22	106855.86
2013	149.70	107005.56
2013	708.58	107714.14
2013	289.42	108003.56
2013	1516.96	109520.52
2013	2534.92	112055.44
2013	548.90	112604.34
2013	459.08	113063.42
2013	1581.83	114645.25
2013	419.16	115064.41
2013	1482.03	116546.44
2013	284.43	116830.87
2013	0.00	116830.87
2013	1761.47	118592.34
2013	2485.02	121077.36
2013	0.00	121077.36
2013	1516.96	122594.32
2013	254.49	122848.81
2013	1432.13	124280.94
2013	204.59	124485.53
2013	2485.02	126970.55
2013	748.50	127719.05
2013	49.90	127768.95
2013	1327.34	129096.29
2013	394.21	129490.50
2013	593.81	130084.31
2013	2420.15	132504.46
2014	2569.85	2569.85
2014	0.00	2569.85
2014	184.63	2754.48
2014	1362.27	4116.75
*/
